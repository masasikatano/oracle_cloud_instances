name: OCI A1.Flex 自動リトライ

on:
  schedule:
    - cron: '*/10 * * * *'
  workflow_dispatch:

jobs:
  retry:
    runs-on: ubuntu-latest
    steps:
      - name: OCI CLI セットアップ
        run: pip install oci-cli

      - name: OCI 設定ファイル作成
        run: |
          mkdir -p ~/.oci
          echo "[DEFAULT]" > ~/.oci/config
          echo "user=${{ secrets.OCI_USER_OCID }}" >> ~/.oci/config
          echo "fingerprint=${{ secrets.OCI_FINGERPRINT }}" >> ~/.oci/config
          echo "tenancy=${{ secrets.OCI_TENANCY_OCID }}" >> ~/.oci/config
          echo "region=${{ secrets.OCI_REGION }}" >> ~/.oci/config
          echo "key_file=/home/runner/.oci/oci_api_key.pem" >> ~/.oci/config
          chmod 600 ~/.oci/config
          echo "${{ secrets.OCI_PRIVATE_KEY }}" > ~/.oci/oci_api_key.pem
          chmod 600 ~/.oci/oci_api_key.pem

      - name: インスタンス作成を試みる
        id: create_instance
        env:
          OCI_CLI_SUPPRESS_FILE_PERMISSIONS_WARNING: "True"
          SUPPRESS_LABEL_WARNING: "True"
        run: |
          echo "$(date): Applyを試みています..."

          JOB=$(oci resource-manager job create-apply-job \
            --stack-id ${{ secrets.OCI_STACK_ID }} \
            --execution-plan-strategy AUTO_APPROVED \
            2>&1)

          echo "$JOB"

          JOB_ID=$(echo "$JOB" | python3 -c "import sys,json; print(json.load(sys.stdin)['data']['id'])" 2>/dev/null)

          if [ -z "$JOB_ID" ]; then
            echo "ジョブ作成失敗（キャパシティ不足の可能性）"
            echo "result=failed" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ジョブID: $JOB_ID"

          for i in $(seq 1 10); do
            sleep 30
            STATE=$(oci resource-manager job get \
              --job-id $JOB_ID \
              | python3 -c "import sys,json; print(json.load(sys.stdin)['data']['lifecycle-state'])")

            echo "状態: $STATE"

            if [ "$STATE" = "SUCCEEDED" ]; then
              echo "✅ インスタンス作成成功！"
              echo "result=succeeded" >> $GITHUB_OUTPUT
              exit 0
            elif [ "$STATE" = "FAILED" ]; then
              echo "❌ 失敗。次回リトライを待ちます。"
              echo "result=failed" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

          echo "result=failed" >> $GITHUB_OUTPUT

      - name: 成功通知メール
        if: steps.create_instance.outputs.result == 'succeeded'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          secure: true
          username: ${{ secrets.GMAIL_USER }}
          password: ${{ secrets.GMAIL_PASSWORD }}
          to: masasikatano@gmail.com
          from: ${{ secrets.GMAIL_USER }}
          subject: "✅ OCI A1.Flex インスタンス作成成功！"
          body: "A1.Flexインスタンスの作成に成功しました。OCIコンソールを確認してください。"

      - name: 成功後にワークフローを無効化
        if: steps.create_instance.outputs.result == 'succeeded'
        run: |
          curl -X PUT \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/oci-retry.yml/disable
